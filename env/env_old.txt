#!/bin/bash
source env.conf

# Função para executar comandos remotos com sudo
run_remote() {
    local host="$1"
    local password="$2"
    local command="$3"

    # Verifica se o comando é para criar um namespace
    if [[ "$command" == *"ip netns add"* ]]; then
        local namespace=$(echo "$command" | awk '{print $4}')  # Extrai o nome do namespace
        ssh -o StrictHostKeyChecking=no "$host" "
            if ip netns list | grep -q '$namespace'; then
                echo 'O namespace $namespace já existe. Ignorando criação.'
            else
                echo '$password' | sudo -S $command
            fi
        "
    else
        [[ "$command" == *"ip route add"* ]]; then
        local route=$(echo "$command" | awk '{print $4, $5, $6}')  # Extrai a rota
        ssh -o StrictHostKeyChecking=no "$host" "
            if ! ip route show | grep -q '$route'; then
                sudo $command
            else
                echo 'A rota $route já existe. Ignorando adição.'
            fi
        "
    else
        # Executa o comando com sudo e fornece a senha
        ssh -o StrictHostKeyChecking=no "$host" "echo '$password' | sudo -S bash -c '$command'"
    fi

    if [ $? -ne 0 ]; then
        echo "Erro ao executar comando no host $host: $command"
        exit 1
    fi
}

# Adiciona um namespace de rede no HOST2
run_remote "$HOST2" "$H2_pwrd" "ip netns add $ue_ns"

# Adiciona uma rota no HOST1
run_remote "$HOST1" "$H1_pwrd" "ip route add $open5gs_docker_addr via $HOST2_ip"

# Inicia contêineres no HOST2 em segundo plano
run_remote "$HOST2" "$H2_pwrd" "cd $srs_5gc && docker compose up --build 5gc &"
run_remote "$HOST2" "$H2_pwrd" "cd $ric_sc && docker compose up --build &"

# Aguarda 5 segundos para garantir que os contêineres estejam em execução
sleep 10

# Inicia o gNB no HOST1 em segundo plano
run_remote "$HOST1" "$H1_pwrd" "sh $srs_gnb_path -c $gnb_yaml &"

# Aguarda 5 segundos
sleep 5

# Inicia o UE no HOST1 em segundo plano
run_remote "$HOST1" "$H1_pwrd" "sh $srs_ue_path srs_ue &"

echo "Script concluído com sucesso!"